<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Watch Video</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <h1>Video Streaming</h1>
    <video id="video" controls></video>

    <script>
        var socket = io();
        var video = document.getElementById('video');
        var videoUrl = '{{ video_url }}';
        var sessionCode = '{{ session_code }}';
        var isSyncing = false;

        if (Hls.isSupported()) {
            var hls = new Hls();
            hls.loadSource(videoUrl);
            hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoUrl;
        }

        socket.emit('join', { session_code: sessionCode });

        video.onplay = video.onpause = video.onseeked = function(event) {
            if (!isSyncing) {
                socket.emit('sync_command', { action: event.type, currentTime: video.currentTime, session_code: sessionCode });
            }
        };

        socket.on('sync_action', function(data) {
            isSyncing = true;
            video.currentTime = data.currentTime;
            if (data.action === 'play') video.play();
            if (data.action === 'pause') video.pause();
            setTimeout(function() { isSyncing = false; }, 1000);
        });

        socket.on('new_user_joined', function(data) {
            if (!video.paused && sessionCode === data.session_code) {
                socket.emit('report_current_time', { currentTime: video.currentTime, session_code: sessionCode });
            }
        });

        socket.on('update_time', function(data) {
            if (isSyncing) return;
            video.currentTime = data.currentTime;
            if (!video.paused) video.play();
        });
    </script>
</body>
</html>